#!/bin/bash
# ============================
# Solutionz INC RMM Connectivity Check (Linux)
# System Admin: Darrel Della
# Last Updated: 2025-11-18
# Description: Performs network diagnostics to verify connectivity to Domotz cloud services.
# ============================

# --- Ensure script is run with sudo ---
if [ "$EUID" -ne 0 ]; then
  echo "Please run this script with sudo"
  exit 1
fi

# --- Define colors ---
YELLOW="\e[33m"
NC="\e[0m"

# --- Check and install missing packages ---
required_packages=(traceroute dnsutils curl openssl netcat-openbsd)
missing_packages=()

for pkg in "${required_packages[@]}"; do
  if ! dpkg -s "$pkg" &> /dev/null; then
    missing_packages+=("$pkg")
  fi
done

if [ ${#missing_packages[@]} -gt 0 ]; then
  echo "Installing missing packages: ${missing_packages[*]}"
  apt install "${missing_packages[@]}" -y
else
  echo "All required packages are already installed. Skipping installation."
fi

# --- Log setup ---
log_file="/var/log/RMM_Connection_Check.txt"
{
  echo "===== RMM Connectivity Check Log ====="
  echo "Log started at: $(date '+%Y-%m-%d %H:%M:%S')"
  echo "======================================"
} > "$log_file"

echo "Logging output to $log_file and displaying in terminal..."
exec > >(tee -a "$log_file") 2>&1

echo "Beginning connectivity checks..."

# --- Display logo and welcome ---
echo -e "\e[36m
  _____   ____    _      _    _   _____   _    ____   _     _
 / ____| / __ \  | |    | |  | | |_   _| | |  / __ \ | \   | |  _____
| (___  | |  | | | |    | |  | |   | |   | | | |  | ||  \  | | |___ /
 \___ \ | |  | | | |    | |  | |   | |   | | | |  | || |\ \| |   / /
 ____) || |__| | | |___ | |__| |   | |   | | | |__| || | \   |  / /__
|_____/  \____/  |_____| \____/    |_|   |_|  \____/ |_|   \_| /_____|

Welcome to the Solutionz INC diagnostic script.
\e[0m"

# --- Summary of Diagnostic Steps ---
echo -e "\n\e[1mSummary: This script will perform the following diagnostic checks:\e[0m"
echo "1. Verify required tools are installed (traceroute, dig, curl, openssl)."
echo "2. Display current network interface IP addresses."
echo "3. Show routing table and interface status."
echo "4. Perform traceroute to portal.domotz.com."
echo "5. Test DNS resolution (system and fallback via 8.8.8.8)."
echo "6. Test HTTP and SSL connectivity to Domotz cloud."
echo "7. Check TCP port availability for Domotz API and messaging services."
echo "8. Ping and test TCP ports for remote Domotz relay endpoints."
echo "9. Test provisioning and orchestration endpoints."
echo "10. Verify connectivity to Canonical update and HTTPS services."
echo "11. Send UDP packets to NTP servers to verify time sync."
echo -e "\nResults will be logged to: $log_file\n"

# --- Test Functions ---
test_tcp_port() {
  local host="$1"
  local port="$2"
  local result

  if command -v nc &> /dev/null; then
    echo "Testing $host:$port..."
    result=$(nc -z -v -w3 "$host" "$port" 2>&1)
    echo "$result"
    if echo "$result" | grep -q succeeded; then
      echo "$host:$port - TCP OPEN"
    else
      echo "$host:$port - TCP CLOSED"
    fi
  else
    echo "WARNING: 'nc' not found. Falling back to /dev/tcp for $host:$port"
    if timeout 5 bash -c "echo > /dev/tcp/$host/$port" &> /dev/null; then
      echo "$host:$port - TCP OPEN"
    else
      echo "$host:$port - TCP CLOSED"
    fi
  fi

  test_icmp "$host"
}

test_udp_port() {
  timeout 5 bash -c "echo > /dev/udp/$1/$2" && echo "$1:$2 - UDP SENT" || echo "$1:$2 - UDP FAILED"
}

test_icmp() {
  ping -c 2 -W 3 "$1" &> /dev/null && echo "$1 - ICMP REACHABLE" || echo "$1 - ICMP UNREACHABLE"
}

test_dns() {
  dig +short "$1" &> /dev/null && echo "$1 - DNS RESOLVED" || echo "$1 - DNS FAILED"
}

test_dns_fallback() {
  dig +short "$1" @8.8.8.8 &> /dev/null && echo "$1 - DNS RESOLVED via 8.8.8.8" || echo "$1 - DNS FAILED via fallback"
}

test_http() {
  local code
  code=$(curl -s -o /dev/null -w "%{http_code}" "https://$1")
  if [ "$code" -eq 200 ]; then
    echo "$1 - HTTP SUCCESS"
  else
    echo "$1 - HTTP FAILED (code $code)"
  fi
}

test_ssl() {
  echo | timeout 5 openssl s_client -connect "$1:443" -servername "$1" &> /dev/null && echo "$1 - SSL VALID" || echo "$1 - SSL INVALID"
}

# --- Device Info ---
echo -e "${YELLOW}--- DEVICE INFORMATION ---${NC}"
ip -4 addr show | grep inet

echo -e "${YELLOW}--- ROUTING TABLE ---${NC}"
ip route show

echo -e "${YELLOW}--- INTERFACE STATUS ---${NC}"
ip link show

# --- Trace Route ---
echo -e "${YELLOW}--- TRACE ROUTE TO portal.domotz.com ---${NC}"
timeout 10 traceroute portal.domotz.com

# --- Connectivity Checks ---
echo -e "${YELLOW}--- GENERAL CONNECTIVITY ---${NC}"
test_dns "portal.domotz.com"
test_dns_fallback "portal.domotz.com"
test_http "portal.domotz.com"
test_ssl "portal.domotz.com"
test_tcp_port "portal.domotz.com" 443

test_dns "echo.domotz.com"
test_dns_fallback "echo.domotz.com"
test_icmp "echo.domotz.com"

echo -e "${YELLOW}--- API CONNECTIVITY ---${NC}"
test_tcp_port "api-us-east-1-cell-1.domotz.com" 443
test_tcp_port "api-eu-west-1-cell-1.domotz.com" 443

echo -e "${YELLOW}--- MESSAGING SERVICES ---${NC}"
test_tcp_port "messaging-us-east-1-cell-1.domotz.com" 5671
test_tcp_port "messaging-eu-west-1-cell-1.domotz.com" 5671

echo -e "${YELLOW}--- REMOTE CONNECTIONS ---${NC}"
remote_hosts=(
  "sshg.domotz.co"
  "us-east-1-sshg.domotz.co"
  "us-east-1-02-sshg.domotz.co"
  "us-west-2-sshg.domotz.co"
  "ap-southeast-2-sshg.domotz.co"
)
sample_ports=(32700 40000 50000 57699)

for host in "${remote_hosts[@]}"; do
  test_icmp "$host"
  for port in "${sample_ports[@]}"; do
    test_tcp_port "$host" "$port"
  done
done

echo -e "${YELLOW}--- PROVISIONING CHANNEL ---${NC}"
test_tcp_port "provisioning.domotz.com" 4505
test_tcp_port "provisioning.domotz.com" 4506
test_tcp_port "login.ubuntu.com" 443
test_tcp_port "pool.sks-keyservers.net" 11371
test_tcp_port "messaging.orchestration.domotz.com" 5671
test_tcp_port "api.orchestration.wl-pro.com" 443
test_tcp_port "tunny.domotz.org" 55022

# --- UPDATES FROM CANONICAL ---
echo -e "${YELLOW}--- UPDATES FROM CANONICAL ---${NC}"
canonical_hosts=(
  "api.snapcraft.io"
  "serial-vault-partners.canonical.com"
  "storage.snapcraftcontent.com"
  "canonical-lgw01.cdn.snapcraftcontent.com"
  "canonical-lcy01.cdn.snapcraftcontent.com"
  "canonical-lcy02.cdn.snapcraftcontent.com"
  "canonical-bos01.cdn.snapcraftcontent.com"
  "upload.apps.ubuntu.com"
)
for host in "${canonical_hosts[@]}"; do
  test_tcp_port "$host" 443
done

# --- HTTPS SERVERS ---
echo -e "${YELLOW}--- HTTPS SERVERS ---${NC}"
https_hosts=("www.google.com" "www.fast.com" "www.canonical.com" "www.redhat.com")
for host in "${https_hosts[@]}"; do
  test_tcp_port "$host" 443
done

# --- NTP SERVERS (UDP 123) ---
echo -e "${YELLOW}--- NTP SERVERS (UDP 123) ---${NC}"
ntp_servers=("0.ubuntu.pool.ntp.org" "1.ubuntu.pool.ntp.org" "2.ubuntu.pool.ntp.org")
for server in "${ntp_servers[@]}"; do
  test_udp_port "$server" 123
done

# --- Final timestamp and attribution ---
echo "======================================"
echo "Log completed at: $(date '+%Y-%m-%d %H:%M:%S')"
echo "Log saved to: $log_file"
echo "Script maintained by: System Admin - Darrel Della"
echo "======================================"
